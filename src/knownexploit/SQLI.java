package knownexploit;

import java.util.ArrayList;

import app.App;
import entrypoint.EntryPoint;
import entrypoint.SQLIEntryPoint;
import sink.SQLISink;
import sink.Sink;
import validation.SQLIValidation;
import xml.XMLParser;

public class SQLI extends KnownExploit{

	public SQLI(ArrayList<String> codeLines){
		super(codeLines, "SQL Injection", new XMLParser("configs/SQLI.xml"));
	}
	
	@Override
	public boolean isVunerable() {
		Boolean vunerability = false;
		if(!_sinks.isEmpty()){	
			String query = "";
			
			for(Sink s : _sinks){
				
				if(_variableAndValue.containsKey(s.getFirstArgument())){
					query = _variableAndValue.get(s.getFirstArgument());
					
					for(EntryPoint e : _eps){
						
						if(query.contains(e.getVariable())){
							vunerability = true;
							if(!App.ansiColors){								
								_vunerabilityIntel += "Vunerability type: " + _vunerabilityType + ".\n"
								+ "Query stored on '" + s.getFirstArgument() + "' "
								+ "contains user input stored on '" + e.getVariable() + "', that it's not sanitized.\n"
								+ "Add '" + e.getVariable() + "=" + _xmlParser.getValidator(s.getSinkPattern()) +"(" + e.getEntryPointValue() + ")'"
								+ "to fix it.\n\n";
							}else{
								_vunerabilityIntel += "Vunerability type: " + App.ANSI_RED + _vunerabilityType + App.ANSI_RESET + ".\n"
								+ "Query stored on " + App.ANSI_CYAN + "'" + s.getFirstArgument() + "' " + App.ANSI_RESET
								+ "contains user input stored on " + App.ANSI_CYAN + "'" + e.getVariable() + "'" + App.ANSI_RESET + ", that it's not sanitized.\n"
								+ "Add '" + App.ANSI_GREEN + e.getVariable() + "=" + _xmlParser.getValidator(s.getSinkPattern()) +"(" + e.getEntryPointValue() + ")'" + App.ANSI_RESET
								+ "to fix it.\n\n";
							}
						}
					}
				}
			}
		}
		return vunerability;
	}


	@Override
	protected void doLogic() {
		for(String line : getCodeLines()){		
			_ep = new SQLIEntryPoint(line, _xmlParser.getEntryPoints());
			_sink = new SQLISink(line, _xmlParser.getSinks());
			_validation = new SQLIValidation(line, _xmlParser.getValidations());
			
			if(!_sink.isSink())
				_sink = null;
			else _sinks.add(_sink);
	
			if(!_ep.isEntryPoint())
				_ep = null;
			else _eps.add(_ep);
	
			if((_ep == null) && (_sink == null)){
				fillVariableAndValue(line);
			}
		}
	}
}