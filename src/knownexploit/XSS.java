package knownexploit;

import java.util.ArrayList;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import app.App;
import entrypoint.EntryPoint;
import entrypoint.XSSEntryPoint;
import sink.Sink;
import sink.XSSSink;
import xml.XMLParser;

public class XSS extends KnownExploit{

	public XSS(ArrayList<String> codeLines){
		super(codeLines, "Cross Site Scripting", new XMLParser("configs/XSS.xml"));
	}
	
	@Override
	public boolean isVunerable() {
		Boolean vunerability = false;
		if(!_sinks.isEmpty()){	
			for(Sink s : _sinks){
				
				for(EntryPoint ep : _eps){
					
					if(s.getFirstArgument().equals(ep.getInputText())){
						vunerability = true;
						if(!App.ansiColors){								
							_vunerabilityIntel += "Vunerability type: " + _vunerabilityType + ".\n"
							+ "A vunerable function '" + _sink.getSinkPattern() + "' "
							+ "executes '" + resolveVariableToValue(_sink.getFirstArgument()) + "', that it's not sanitized.\n"
							+ "Add '" + _xmlParser.getValidator(_sink.getSinkPattern()) + "'"
							+ "to fix it.\n\n";
						}else{
							_vunerabilityIntel += "Vunerability type: " + _vunerabilityType + ".\n"
							+ "A vunerable function '" + _sink.getSinkPattern() + "' "
							+ "executes '" + resolveVariableToValue(_sink.getFirstArgument()) + "', that it's not sanitized.\n"
							+ "Add '" + _xmlParser.getValidator(_sink.getSinkPattern()) + "'"
							+ "to fix it.\n\n";
						}
					}
				}
			}
		}
		return vunerability;
	}
	
	private String resolveVariableToValue(String var){
		String entryPoint = "";
		if(!_variableAndValue.isEmpty())
			entryPoint = _variableAndValue.get(var);
		else entryPoint = var;
		
		return entryPoint;
	} 

	@Override
	protected void doLogic() {
		Pattern r = Pattern.compile("<?php (.*?)[?>]");
		String withPhp = "";
		String sink = "";
		String entryPoint = "";
		String[] parser;

		for(String line : getCodeLines()){
			Matcher m = r.matcher(line);
			if(m.find())
				withPhp = m.group(1);//echo $firstname; || echo $_SERVER["PHP_SELF"]
			
			if(withPhp.isEmpty())
				withPhp = line;
			
			if((withPhp.charAt(withPhp.length() - 1) == ";".charAt(0)) && (withPhp.contains("="))){//$firstname = $_POST['firstname'];
				fillVariableAndValue(withPhp);
			}else{ 
				if(withPhp.contains(" ")){//echo $_POST['username']; || //echo $firstname; || echo $_SERVER["PHP_SELF"]
					
					withPhp = withPhp.replace(";", "");
					
					parser = withPhp.split(" ", 2);
					sink = parser[0];
					entryPoint = parser[1];
					
					_ep = new XSSEntryPoint(resolveVariableToValue(entryPoint), _xmlParser.getEntryPoints());
					_sink = new XSSSink(sink, _xmlParser.getSinks());
					_sink.setPossibleEP(resolveVariableToValue(entryPoint));
					_sinks.add(_sink);
					_eps.add(_ep);
				}
				
			}
			withPhp = "";
		}
		
	}

}
